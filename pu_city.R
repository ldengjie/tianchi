library("TSclust")
library("mclust")
library("xts")
od1<-read.csv("purchase_by_type_sum_p1_v4.csv")
od2<-read.csv("purchase_by_type_sum_p2_v4.csv")
od<-od1+od2
fitbeg<-275;#20140401
fitend<-427;#20140831
prebeg<-fitend+1;
preend<-457;#20140930
fd<-od[fitbeg:fitend,]

report_date         <-ts(fd$report_date,fre=7)
total_purchase_amt  <-ts(log(fd$total_purchase_amt ),fre=7)
izfb11                <-ts(log(fd$zfb11),fre=7)
izfb12                <-ts(log(fd$zfb12),fre=7)
izfb13                <-ts(log(fd$zfb13),fre=7)
izfb14                <-ts(log(fd$zfb14),fre=7)
izfb15                <-ts(log(fd$zfb15),fre=7)
izfb16                <-ts(log(fd$zfb16),fre=7)
izfb17                <-ts(log(fd$zfb17),fre=7)
izfb21                <-ts(log(fd$zfb21),fre=7)
izfb22                <-ts(log(fd$zfb22),fre=7)
izfb23                <-ts(log(fd$zfb23),fre=7)
izfb24                <-ts(log(fd$zfb24),fre=7)
izfb25                <-ts(log(fd$zfb25),fre=7)
izfb26                <-ts(log(fd$zfb26),fre=7)
izfb27                <-ts(log(fd$zfb27),fre=7)
izfb31                <-ts(log(fd$zfb31),fre=7)
izfb32                <-ts(log(fd$zfb32),fre=7)
izfb33                <-ts(log(fd$zfb33),fre=7)
izfb34                <-ts(log(fd$zfb34),fre=7)
izfb35                <-ts(log(fd$zfb35),fre=7)
izfb36                <-ts(log(fd$zfb36),fre=7)
izfb37                <-ts(log(fd$zfb37),fre=7)
ibank11               <-ts(log(fd$bank11),fre=7)
ibank12               <-ts(log(fd$bank12),fre=7)
ibank13               <-ts(log(fd$bank13),fre=7)
ibank14               <-ts(log(fd$bank14),fre=7)
ibank15               <-ts(log(fd$bank15),fre=7)
ibank16               <-ts(log(fd$bank16),fre=7)
ibank17               <-ts(log(fd$bank17),fre=7)
ibank21               <-ts(log(fd$bank21),fre=7)
ibank22               <-ts(log(fd$bank22),fre=7)
ibank23               <-ts(log(fd$bank23),fre=7)
ibank24               <-ts(log(fd$bank24),fre=7)
ibank25               <-ts(log(fd$bank25),fre=7)
ibank26               <-ts(log(fd$bank26),fre=7)
ibank27               <-ts(log(fd$bank27),fre=7)
ibank31               <-ts(log(fd$bank31),fre=7)
ibank32               <-ts(log(fd$bank32),fre=7)
ibank33               <-ts(log(fd$bank33),fre=7)
ibank34               <-ts(log(fd$bank34),fre=7)
ibank35               <-ts(log(fd$bank35),fre=7)
ibank36               <-ts(log(fd$bank36),fre=7)
ibank37               <-ts(log(fd$bank37),fre=7)
share               <-ts(log(fd$share),fre=7)
#plot(as.zoo(cbind(
#xts(exp(izfb11)+exp(izfb12)+exp(izfb13)+exp(izfb14)+exp(izfb15)+exp(izfb16)+exp(izfb17),seq(as.POSIXct("2014-04-01"),len=length(izfb11),by='day'))
#,xts(exp(izfb11),seq(as.POSIXct("2014-04-01"),len=length(izfb11),by='day'))
#,xts(exp(izfb12),seq(as.POSIXct("2014-04-01"),len=length(izfb12),by='day'))
#,xts(exp(izfb13),seq(as.POSIXct("2014-04-01"),len=length(izfb13),by='day'))
#,xts(exp(izfb14),seq(as.POSIXct("2014-04-01"),len=length(izfb14),by='day'))
#,xts(exp(izfb15),seq(as.POSIXct("2014-04-01"),len=length(izfb15),by='day'))
#,xts(exp(izfb16),seq(as.POSIXct("2014-04-01"),len=length(izfb16),by='day'))
#,xts(exp(izfb17),seq(as.POSIXct("2014-04-01"),len=length(izfb17),by='day'))
#,xts(exp(izfb21)+exp(izfb22)+exp(izfb23)+exp(izfb24)+exp(izfb25)+exp(izfb26)+exp(izfb27),seq(as.POSIXct("2014-04-01"),len=length(izfb21),by='day'))
#,xts(exp(izfb21),seq(as.POSIXct("2014-04-01"),len=length(izfb21),by='day'))
#,xts(exp(izfb22),seq(as.POSIXct("2014-04-01"),len=length(izfb22),by='day'))
#,xts(exp(izfb23),seq(as.POSIXct("2014-04-01"),len=length(izfb23),by='day'))
#,xts(exp(izfb24),seq(as.POSIXct("2014-04-01"),len=length(izfb24),by='day'))
#,xts(exp(izfb25),seq(as.POSIXct("2014-04-01"),len=length(izfb25),by='day'))
#,xts(exp(izfb26),seq(as.POSIXct("2014-04-01"),len=length(izfb26),by='day'))
#,xts(exp(izfb27),seq(as.POSIXct("2014-04-01"),len=length(izfb27),by='day'))
#,xts(exp(izfb31)+exp(izfb32)+exp(izfb33)+exp(izfb34)+exp(izfb35)+exp(izfb36)+exp(izfb37),seq(as.POSIXct("2014-04-01"),len=length(izfb31),by='day'))
#,xts(exp(izfb31),seq(as.POSIXct("2014-04-01"),len=length(izfb31),by='day'))
#,xts(exp(izfb32),seq(as.POSIXct("2014-04-01"),len=length(izfb32),by='day'))
#,xts(exp(izfb33),seq(as.POSIXct("2014-04-01"),len=length(izfb33),by='day'))
#,xts(exp(izfb34),seq(as.POSIXct("2014-04-01"),len=length(izfb34),by='day'))
#,xts(exp(izfb35),seq(as.POSIXct("2014-04-01"),len=length(izfb35),by='day'))
#,xts(exp(izfb36),seq(as.POSIXct("2014-04-01"),len=length(izfb36),by='day'))
#,xts(exp(izfb37),seq(as.POSIXct("2014-04-01"),len=length(izfb37),by='day'))
#)),col=c(1:6,8,9),lty=1:8,main="purchase_zfb")
#plot(as.zoo(cbind(
#xts(exp(ibank11)+exp(ibank12)+exp(ibank13)+exp(ibank14)+exp(ibank15)+exp(ibank16)+exp(ibank17),seq(as.POSIXct("2014-04-01"),len=length(ibank11),by='day'))
#,xts(exp(ibank11),seq(as.POSIXct("2014-04-01"),len=length(ibank11),by='day'))
#,xts(exp(ibank12),seq(as.POSIXct("2014-04-01"),len=length(ibank12),by='day'))
#,xts(exp(ibank13),seq(as.POSIXct("2014-04-01"),len=length(ibank13),by='day'))
#,xts(exp(ibank14),seq(as.POSIXct("2014-04-01"),len=length(ibank14),by='day'))
#,xts(exp(ibank15),seq(as.POSIXct("2014-04-01"),len=length(ibank15),by='day'))
#,xts(exp(ibank16),seq(as.POSIXct("2014-04-01"),len=length(ibank16),by='day'))
#,xts(exp(ibank17),seq(as.POSIXct("2014-04-01"),len=length(ibank17),by='day'))
#,
#xts(exp(ibank21)+exp(ibank22)+exp(ibank23)+exp(ibank24)+exp(ibank25)+exp(ibank26)+exp(ibank27),seq(as.POSIXct("2014-04-01"),len=length(ibank21),by='day'))
#,xts(exp(ibank21),seq(as.POSIXct("2014-04-01"),len=length(ibank21),by='day'))
#,xts(exp(ibank22),seq(as.POSIXct("2014-04-01"),len=length(ibank22),by='day'))
#,xts(exp(ibank23),seq(as.POSIXct("2014-04-01"),len=length(ibank23),by='day'))
#,xts(exp(ibank24),seq(as.POSIXct("2014-04-01"),len=length(ibank24),by='day'))
#,xts(exp(ibank25),seq(as.POSIXct("2014-04-01"),len=length(ibank25),by='day'))
#,xts(exp(ibank26),seq(as.POSIXct("2014-04-01"),len=length(ibank26),by='day'))
#,xts(exp(ibank27),seq(as.POSIXct("2014-04-01"),len=length(ibank27),by='day'))
#,
#xts(exp(ibank31)+exp(ibank32)+exp(ibank33)+exp(ibank34)+exp(ibank35)+exp(ibank36)+exp(ibank37),seq(as.POSIXct("2014-04-01"),len=length(ibank31),by='day'))
#,xts(exp(ibank31),seq(as.POSIXct("2014-04-01"),len=length(ibank31),by='day'))
#,xts(exp(ibank32),seq(as.POSIXct("2014-04-01"),len=length(ibank32),by='day'))
#,xts(exp(ibank33),seq(as.POSIXct("2014-04-01"),len=length(ibank33),by='day'))
#,xts(exp(ibank34),seq(as.POSIXct("2014-04-01"),len=length(ibank34),by='day'))
#,xts(exp(ibank35),seq(as.POSIXct("2014-04-01"),len=length(ibank35),by='day'))
#,xts(exp(ibank36),seq(as.POSIXct("2014-04-01"),len=length(ibank36),by='day'))
#,xts(exp(ibank37),seq(as.POSIXct("2014-04-01"),len=length(ibank37),by='day'))
#)),col=c(1:6,8,9),lty=1:8,main="purchase_bank")

zfb1<-as.matrix(scale(cbind(fd$zfb11,fd$zfb12,fd$zfb13,fd$zfb14,fd$zfb15,fd$zfb16,fd$zfb17)))
zfb2<-as.matrix(scale(cbind(fd$zfb21,fd$zfb22,fd$zfb23,fd$zfb24,fd$zfb25,fd$zfb26,fd$zfb27)))
zfb3<-as.matrix(scale(cbind(fd$zfb31,fd$zfb32,fd$zfb33,fd$zfb34,fd$zfb35,fd$zfb36,fd$zfb37)))
bank1<-as.matrix(scale(cbind(fd$bank11,fd$bank12,fd$bank13,fd$bank14,fd$bank15,fd$bank16,fd$bank17)))
bank2<-as.matrix(scale(cbind(fd$bank21,fd$bank22,fd$bank23,fd$bank24,fd$bank25,fd$bank26,fd$bank27)))
bank3<-as.matrix(scale(cbind(fd$bank31,fd$bank32,fd$bank33,fd$bank34,fd$bank35,fd$bank36,fd$bank37)))

for(ki in 2:6)
{
    cat("===>",ki,"\n")
    for(d in list(zfb1,zfb2,zfb3,bank1,bank2,bank3))
    {
        cat("---\n")
        dt=t(d)
        cat("#EM\n")
        fm<-Mclust(dt,ki)
        print(fm$class)
        cat("#HC-diss\n")
        zfbmds<-diss(dt,"DTWARP",p=0.05)               
        zfbhc<-hclust(zfbmds)                             
        print(cutree(zfbhc,k=ki) )
        cat("#HC\n")
        zfbmtd<-dist(dt)
        zfbmtc<-hclust(zfbmtd,method="complete")
        print(cutree(zfbmtc,k=ki))
        cat("#k-Means\n")
        k<-kmeans(dt,ki)
        print(k$cluster)
        cat("#k-Medoids\n")
        p<-pam(dt,ki)
        print(p$clustering)

    }

}

